/* enchant.js v0.8.3 http://enchantjs.com Copyright (c) UEI Corporation Released Under the MIT license. */
!function(a,b){"function"!=typeof Object.defineProperty&&(Object.defineProperty=function(a,b,c){return"value"in c&&(a[b]=c.value),"get"in c&&a.__defineGetter__(b,c.get),"set"in c&&a.__defineSetter__(b,c.set),a}),"function"!=typeof Object.defineProperties&&(Object.defineProperties=function(a,b){for(var c in b)b.hasOwnProperty(c)&&Object.defineProperty(a,c,b[c]);return a}),"function"!=typeof Object.create&&(Object.create=function(a,b){function c(){}c.prototype=a;var d=new c;return null!=b&&Object.defineProperties(d,b),d}),"function"!=typeof Object.getPrototypeOf&&(Object.getPrototypeOf=function(a){return a.__proto__}),"function"!=typeof Function.prototype.bind&&(Function.prototype.bind=function(b){var c=this,d=Array.prototype.slice.call(arguments,1),e=function(){},f=function(){var f=d.concat(Array.prototype.slice.call(arguments));return c.apply(this instanceof e?this:b||a,f)};return e.prototype=c.prototype,f.prototype=new e,f}),a.getTime=function(){var b;return a.performance&&a.performance.now?(b=Date.now(),function(){return b+a.performance.now()}):a.performance&&a.performance.webkitNow?(b=Date.now(),function(){return b+a.performance.webkitNow()}):Date.now}(),a.requestAnimationFrame=a.requestAnimationFrame||a.mozRequestAnimationFrame||a.webkitRequestAnimationFrame||a.msRequestAnimationFrame||function(){var b=a.getTime(),c=1e3/60;return function(d){var e=setTimeout(function(){b=a.getTime(),d(b)},Math.max(0,b+c-a.getTime()));return e}}();var c=function(b){if(null!=b&&(b instanceof Array||(b=Array.prototype.slice.call(arguments)),b=b.filter(function(a){return[a].join()})),function c(d,e){var f,g,h=[];for(var i in d)d.hasOwnProperty(i)&&("function"==typeof d[i]?a[i]=d[i]:"object"==typeof d[i]&&null!==d[i]&&Object.getPrototypeOf(d[i])===Object.prototype&&(null==b?h.push(i):(f=b.indexOf(e+i),f!==-1&&(h.push(i),b.splice(f,1)))));for(f=0,g=h.length;f<g;f++)c(d[h[f]],e+h[f]+".")}(c,""),c.Class.getInheritanceTree(a.Game).length<=c.Class.getInheritanceTree(a.Core).length&&(a.Game=a.Core),null!=b&&b.length)throw new Error("Cannot load module: "+b.join(", "))};a.enchant=c,a.addEventListener("message",function(a,b){try{var d=JSON.parse(a.data);if("event"===d.type)c.Core.instance.dispatchEvent(new c.Event(d.value));else if("debug"===d.type)switch(d.value){case"start":c.Core.instance.start();break;case"pause":c.Core.instance.pause();break;case"resume":c.Core.instance.resume();break;case"tick":c.Core.instance._tick()}}catch(e){}},!1),c.Class=function(a,b){return c.Class.create(a,b)},c.Class.create=function(a,b){if(null==a&&b)throw new Error("superclass is undefined (enchant.Class.create)");if(null==a)throw new Error("definition is undefined (enchant.Class.create)");if(0===arguments.length)return c.Class.create(Object,b);if(1===arguments.length&&"function"!=typeof arguments[0])return c.Class.create(Object,arguments[0]);for(var d in b)b.hasOwnProperty(d)&&("object"==typeof b[d]&&null!==b[d]&&Object.getPrototypeOf(b[d])===Object.prototype?"enumerable"in b[d]||(b[d].enumerable=!0):b[d]={value:b[d],enumerable:!0,writable:!0});var e=function(){return this instanceof e?void e.prototype.initialize.apply(this,arguments):new e};e.prototype=Object.create(a.prototype,b),e.prototype.constructor=e,null==e.prototype.initialize&&(e.prototype.initialize=function(){a.apply(this,arguments)});for(var f=this.getInheritanceTree(a),g=0,h=f.length;g<h;g++)if("function"==typeof f[g]._inherited){f[g]._inherited(e);break}return e},c.Class.getInheritanceTree=function(a){for(var b=[],c=a,d=c.prototype;c!==Object;)b.push(c),d=Object.getPrototypeOf(d),c=d.constructor;return b},c.ENV={VERSION:"0.8.3",BROWSER:function(a){return/Eagle/.test(a)?"eagle":/Opera/.test(a)?"opera":/MSIE|Trident/.test(a)?"ie":/Chrome/.test(a)?"chrome":/(?:Macintosh|Windows).*AppleWebKit/.test(a)?"safari":/(?:iPhone|iPad|iPod).*AppleWebKit/.test(a)?"mobilesafari":/Firefox/.test(a)?"firefox":/Android/.test(a)?"android":""}(navigator.userAgent),VENDOR_PREFIX:function(){var a=navigator.userAgent;return a.indexOf("Opera")!==-1?"O":/MSIE|Trident/.test(a)?"ms":a.indexOf("WebKit")!==-1?"webkit":"Gecko"===navigator.product?"Moz":""}(),TOUCH_ENABLED:function(){var a=document.createElement("div");return a.setAttribute("ontouchstart","return"),"function"==typeof a.ontouchstart}(),RETINA_DISPLAY:function(){if(navigator.userAgent.indexOf("iPhone")!==-1&&2===a.devicePixelRatio){var b=document.querySelector('meta[name="viewport"]');return null==b&&(b=document.createElement("meta"),document.head.appendChild(b)),b.setAttribute("content","width=640"),!0}return!1}(),USE_FLASH_SOUND:function(){var a=navigator.userAgent,b=navigator.vendor||"";return 0===location.href.indexOf("http")&&a.indexOf("Mobile")===-1&&b.indexOf("Apple")!==-1}(),USE_DEFAULT_EVENT_TAGS:["input","textarea","select","area"],CANVAS_DRAWING_METHODS:["putImageData","drawImage","drawFocusRing","fill","stroke","clearRect","fillRect","strokeRect","fillText","strokeText"],KEY_BIND_TABLE:{37:"left",38:"up",39:"right",40:"down"},PREVENT_DEFAULT_KEY_CODES:[37,38,39,40],SOUND_ENABLED_ON_MOBILE_SAFARI:!0,USE_TOUCH_TO_START_SCENE:!0,USE_WEBAUDIO:function(){return"file:"!==location.protocol}(),USE_ANIMATION:!0,COLOR_DETECTION_LEVEL:2},c.Event=c.Class.create({initialize:function(a){this.type=a,this.target=null,this.x=0,this.y=0,this.localX=0,this.localY=0},_initPosition:function(a,b){var d=c.Core.instance;this.x=this.localX=(a-d._pageX)/d.scale,this.y=this.localY=(b-d._pageY)/d.scale}}),c.Event.LOAD="load",c.Event.ERROR="error",c.Event.CORE_RESIZE="coreresize",c.Event.PROGRESS="progress",c.Event.ENTER_FRAME="enterframe",c.Event.EXIT_FRAME="exitframe",c.Event.ENTER="enter",c.Event.EXIT="exit",c.Event.CHILD_ADDED="childadded",c.Event.ADDED="added",c.Event.ADDED_TO_SCENE="addedtoscene",c.Event.CHILD_REMOVED="childremoved",c.Event.REMOVED="removed",c.Event.REMOVED_FROM_SCENE="removedfromscene",c.Event.TOUCH_START="touchstart",c.Event.TOUCH_MOVE="touchmove",c.Event.TOUCH_END="touchend",c.Event.RENDER="render",c.Event.INPUT_START="inputstart",c.Event.INPUT_CHANGE="inputchange",c.Event.INPUT_END="inputend",c.Event.INPUT_STATE_CHANGED="inputstatechanged",c.Event.LEFT_BUTTON_DOWN="leftbuttondown",c.Event.LEFT_BUTTON_UP="leftbuttonup",c.Event.RIGHT_BUTTON_DOWN="rightbuttondown",c.Event.RIGHT_BUTTON_UP="rightbuttonup",c.Event.UP_BUTTON_DOWN="upbuttondown",c.Event.UP_BUTTON_UP="upbuttonup",c.Event.DOWN_BUTTON_DOWN="downbuttondown",c.Event.DOWN_BUTTON_UP="downbuttonup",c.Event.A_BUTTON_DOWN="abuttondown",c.Event.A_BUTTON_UP="abuttonup",c.Event.B_BUTTON_DOWN="bbuttondown",c.Event.B_BUTTON_UP="bbuttonup",c.Event.ADDED_TO_TIMELINE="addedtotimeline",c.Event.REMOVED_FROM_TIMELINE="removedfromtimeline",c.Event.ACTION_START="actionstart",c.Event.ACTION_END="actionend",c.Event.ACTION_TICK="actiontick",c.Event.ACTION_ADDED="actionadded",c.Event.ACTION_REMOVED="actionremoved",c.Event.ANIMATION_END="animationend",c.EventTarget=c.Class.create({initialize:function(){this._listeners={}},addEventListener:function(a,b){var c=this._listeners[a];null==c?this._listeners[a]=[b]:c.indexOf(b)===-1&&c.unshift(b)},on:function(){this.addEventListener.apply(this,arguments)},removeEventListener:function(a,b){var c=this._listeners[a];if(null!=c){var d=c.indexOf(b);d!==-1&&c.splice(d,1)}},clearEventListener:function(a){null!=a?delete this._listeners[a]:this._listeners={}},dispatchEvent:function(a){a.target=this,a.localX=a.x-this._offsetX,a.localY=a.y-this._offsetY,null!=this["on"+a.type]&&this["on"+a.type](a);var b=this._listeners[a.type];if(null!=b){b=b.slice();for(var c=0,d=b.length;c<d;c++)b[c].call(this,a)}}}),function(){var b;c.Core=c.Class.create(c.EventTarget,{initialize:function(d,e){if(null===a.document.body)throw new Error("document.body is null. Please excute 'new Core()' in window.onload.");c.EventTarget.call(this);var f=!0;b&&(f=!1,b.stop()),b=c.Core.instance=this,this._calledTime=0,this._mousedownID=0,this._surfaceID=0,this._soundID=0,this._scenes=[],d=d||320,e=e||320;var g,h,i,j=document.getElementById("enchant-stage");if(j){var k=a.getComputedStyle(j);for(h=parseInt(k.width,10),i=parseInt(k.height,10),g=h&&i?Math.min(h/d,i/e):1;j.firstChild;)j.removeChild(j.firstChild);j.style.position="relative";var l=j.getBoundingClientRect();this._pageX=Math.round(a.scrollX||a.pageXOffset+l.left),this._pageY=Math.round(a.scrollY||a.pageYOffset+l.top)}else j=document.createElement("div"),j.id="enchant-stage",j.style.position="absolute",document.body.firstChild?document.body.insertBefore(j,document.body.firstChild):document.body.appendChild(j),g=Math.min(a.innerWidth/d,a.innerHeight/e),this._pageX=j.getBoundingClientRect().left,this._pageY=j.getBoundingClientRect().top;j.style.fontSize="12px",j.style.webkitTextSizeAdjust="none",j.style.webkitTapHighlightColor="rgba(0, 0, 0, 0)",this._element=j,this.addEventListener("coreresize",this._oncoreresize),this._width=d,this._height=e,this.scale=g,this.fps=30,this.frame=0,this.ready=!1,this.running=!1,this.assets={};this._assets=[];!function a(b){b.assets&&c.Core.instance.preload(b.assets);for(var d in b)b.hasOwnProperty(d)&&"object"==typeof b[d]&&null!==b[d]&&Object.getPrototypeOf(b[d])===Object.prototype&&a(b[d])}(c),this.currentScene=null,this.rootScene=new c.Scene,this.pushScene(this.rootScene),this.loadingScene=new c.LoadingScene,this._activated=!1,this._offsetX=0,this._offsetY=0,this.input={},this.keyboardInputManager=new c.KeyboardInputManager(a.document,this.input),this.keyboardInputManager.addBroadcastTarget(this),this._keybind=this.keyboardInputManager._binds,c.ENV.KEY_BIND_TABLE||(c.ENV.KEY_BIND_TABLE={});for(var m in c.ENV.KEY_BIND_TABLE)this.keybind(m,c.ENV.KEY_BIND_TABLE[m]);if(f){j=c.Core.instance._element;document.addEventListener("keydown",function(a){b.dispatchEvent(new c.Event("keydown")),c.ENV.PREVENT_DEFAULT_KEY_CODES.indexOf(a.keyCode)!==-1&&(a.preventDefault(),a.stopPropagation())},!0),c.ENV.TOUCH_ENABLED&&(j.addEventListener("touchstart",function(a){var d=a.target.tagName.toLowerCase();c.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(a.preventDefault(),b.running||a.stopPropagation())},!0),j.addEventListener("touchmove",function(a){var d=a.target.tagName.toLowerCase();c.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(a.preventDefault(),b.running||a.stopPropagation())},!0),j.addEventListener("touchend",function(a){var d=a.target.tagName.toLowerCase();c.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(a.preventDefault(),b.running||a.stopPropagation())},!0)),j.addEventListener("mousedown",function(a){var d=a.target.tagName.toLowerCase();c.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(a.preventDefault(),b._mousedownID++,b.running||a.stopPropagation())},!0),j.addEventListener("mousemove",function(a){var d=a.target.tagName.toLowerCase();c.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(a.preventDefault(),b.running||a.stopPropagation())},!0),j.addEventListener("mouseup",function(a){var d=a.target.tagName.toLowerCase();c.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(d)===-1&&(a.preventDefault(),b.running||a.stopPropagation())},!0),b._touchEventTarget={},c.ENV.TOUCH_ENABLED&&(j.addEventListener("touchstart",function(a){for(var b,d,e=c.Core.instance,f=new c.Event(c.Event.TOUCH_START),g=a.changedTouches,h=0,i=g.length;h<i;h++)b=g[h],f._initPosition(b.pageX,b.pageY),d=e.currentScene._determineEventTarget(f),e._touchEventTarget[b.identifier]=d,d.dispatchEvent(f)},!1),j.addEventListener("touchmove",function(a){for(var b,d,e=c.Core.instance,f=new c.Event(c.Event.TOUCH_MOVE),g=a.changedTouches,h=0,i=g.length;h<i;h++)b=g[h],d=e._touchEventTarget[b.identifier],d&&(f._initPosition(b.pageX,b.pageY),d.dispatchEvent(f))},!1),j.addEventListener("touchend",function(a){for(var b,d,e=c.Core.instance,f=new c.Event(c.Event.TOUCH_END),g=a.changedTouches,h=0,i=g.length;h<i;h++)b=g[h],d=e._touchEventTarget[b.identifier],d&&(f._initPosition(b.pageX,b.pageY),d.dispatchEvent(f),delete e._touchEventTarget[b.identifier])},!1)),j.addEventListener("mousedown",function(a){var b=c.Core.instance,d=new c.Event(c.Event.TOUCH_START);d._initPosition(a.pageX,a.pageY);var e=b.currentScene._determineEventTarget(d);b._touchEventTarget[b._mousedownID]=e,e.dispatchEvent(d)},!1),j.addEventListener("mousemove",function(a){var b=c.Core.instance,d=new c.Event(c.Event.TOUCH_MOVE);d._initPosition(a.pageX,a.pageY);var e=b._touchEventTarget[b._mousedownID];e&&e.dispatchEvent(d)},!1),j.addEventListener("mouseup",function(a){var b=c.Core.instance,d=new c.Event(c.Event.TOUCH_END);d._initPosition(a.pageX,a.pageY);var e=b._touchEventTarget[b._mousedownID];e&&e.dispatchEvent(d),delete b._touchEventTarget[b._mousedownID]},!1)}},width:{get:function(){return this._width},set:function(a){this._width=a,this._dispatchCoreResizeEvent()}},height:{get:function(){return this._height},set:function(a){this._height=a,this._dispatchCoreResizeEvent()}},scale:{get:function(){return this._scale},set:function(a){this._scale=a,this._dispatchCoreResizeEvent()}},_dispatchCoreResizeEvent:function(){var a=new c.Event("coreresize");a.width=this._width,a.height=this._height,a.scale=this._scale,this.dispatchEvent(a)},_oncoreresize:function(a){this._element.style.width=Math.floor(this._width*this._scale)+"px",this._element.style.height=Math.floor(this._height*this._scale)+"px";for(var b,c=0,d=this._scenes.length;c<d;c++)b=this._scenes[c],b.dispatchEvent(a)},preload:function(a){var b;if(!(a instanceof Array))if("object"==typeof a){b=[];for(var c in a)a.hasOwnProperty(c)&&b.push([a[c],c]);a=b}else a=Array.prototype.slice.call(arguments);return Array.prototype.push.apply(this._assets,a),this},load:function(a,d,e,f){var g;if("string"==typeof arguments[1])g=d,e=e||function(){},f=f||function(){};else{g=a;var h=e;e=arguments[1]||function(){},f=h||function(){}}var i=c.Core.findExt(a);return c.Deferred.next(function(){var d=new c.Deferred,h=function(a){d.call(a),e.call(this,a)},j=function(a){d.fail(a),f.call(this,a)};if(c.Core._loadFuncs[i])c.Core.instance.assets[g]=c.Core._loadFuncs[i](a,i,h,j);else{var k=new XMLHttpRequest;k.open("GET",a,!0),k.onreadystatechange=function(){if(4===k.readyState){if(200!==k.status&&0!==k.status){var d=new c.Event("error");d.message=k.status+": Cannot load an asset: "+a,j.call(c.Core.instance,d)}var e=k.getResponseHeader("Content-Type")||"";e.match(/^image/)?b.assets[g]=c.Surface.load(a,h,j):e.match(/^audio/)?b.assets[g]=c.Sound.load(a,e,h,j):(b.assets[g]=k.responseText,h.call(c.Core.instance,new c.Event("load")))}},k.send(null)}return d})},start:function(d){var e=function(){this.frame=0,this.removeEventListener("load",e)};if(this.addEventListener("load",e),this.currentTime=a.getTime(),this.running=!0,this.ready=!0,!this._activated&&(this._activated=!0,"mobilesafari"===c.ENV.BROWSER&&c.ENV.USE_WEBAUDIO&&c.ENV.USE_TOUCH_TO_START_SCENE)){var f=new c.Deferred,g=this._createTouchToStartScene();return g.addEventListener(c.Event.TOUCH_START,function a(){this.removeEventListener(c.Event.TOUCH_START,a);var d=new c.WebAudioSound;d.buffer=c.WebAudioSound.audioContext.createBuffer(1,1,48e3),d.play(),b.removeScene(g),b.start(f)},!1),b.pushScene(g),f}this._requestNextFrame(0);var h=this._requestPreload().next(function(){c.Core.instance.loadingScene.dispatchEvent(new c.Event(c.Event.LOAD))});return d&&h.next(function(a){d.call(a)}).error(function(a){d.fail(a)}),h},_requestPreload:function(){var a={},d=0,e=0,f=function(){var a=new c.Event("progress");a.loaded=++d,a.total=e,b.loadingScene.dispatchEvent(a)};return this._assets.reverse().forEach(function(b){var c,d;b instanceof Array?(c=b[0],d=b[1]):c=d=b,a[d]||(a[d]=this.load(c,d,f),e++)},this),this.pushScene(this.loadingScene),c.Deferred.parallel(a)},_createTouchToStartScene:function(){var a=new c.Label("Touch to Start"),d=Math.round(b.width/10),e=new c.Scene;return a.color="#fff",a.font=d-1+"px bold Helvetica,Arial,sans-serif",a.textAlign="center",a.width=b.width,a.height=a._boundHeight,a.y=(b.height-a.height)/2,e.backgroundColor="#000",e.addChild(a),e},debug:function(){return this._debug=!0,this.start()},actualFps:{get:function(){return this._actualFps||this.fps}},_requestNextFrame:function(b){this.ready&&(this.fps>=60||b<=16?(this._calledTime=a.getTime(),a.requestAnimationFrame(this._callTick)):setTimeout(function(){var b=c.Core.instance;b._calledTime=a.getTime(),a.requestAnimationFrame(b._callTick)},Math.max(0,b)))},_callTick:function(a){c.Core.instance._tick(a)},_tick:function(b){var d=new c.Event("enterframe"),e=a.getTime(),f=d.elapsed=e-this.currentTime;this.currentTime=e,this._actualFps=f>0?1e3/f:0;for(var g=this.currentScene.childNodes.slice(),h=Array.prototype.push;g.length;){var i=g.pop();i.age++,i.dispatchEvent(d),i.childNodes&&h.apply(g,i.childNodes)}this.currentScene.age++,this.currentScene.dispatchEvent(d),this.dispatchEvent(d),this.dispatchEvent(new c.Event("exitframe")),this.frame++,e=a.getTime(),this._requestNextFrame(1e3/this.fps-(e-this._calledTime))},getTime:function(){return a.getTime()},stop:function(){this.ready=!1,this.running=!1},pause:function(){this.ready=!1},resume:function(){this.ready||(this.currentTime=a.getTime(),this.ready=!0,this.running=!0,this._requestNextFrame(0))},pushScene:function(a){return this._element.appendChild(a._element),this.currentScene&&this.currentScene.dispatchEvent(new c.Event("exit")),this.currentScene=a,this.currentScene.dispatchEvent(new c.Event("enter")),this._scenes.push(a)},popScene:function(){return this.currentScene===this.rootScene?this.currentScene:(this._element.removeChild(this.currentScene._element),this.currentScene.dispatchEvent(new c.Event("exit")),this.currentScene=this._scenes[this._scenes.length-2],this.currentScene.dispatchEvent(new c.Event("enter")),this._scenes.pop())},replaceScene:function(a){return this.popScene(),this.pushScene(a)},removeScene:function(a){if(this.currentScene===a)return this.popScene();var b=this._scenes.indexOf(a);return b!==-1?(this._scenes.splice(b,1),this._element.removeChild(a._element),a):null},_buttonListener:function(a){this.currentScene.dispatchEvent(a)},keybind:function(a,b){return this.keyboardInputManager.keybind(a,b),this.addEventListener(b+"buttondown",this._buttonListener),this.addEventListener(b+"buttonup",this._buttonListener),this},keyunbind:function(a){var b=this._keybind[a];return this.keyboardInputManager.keyunbind(a),this.removeEventListener(b+"buttondown",this._buttonListener),this.removeEventListener(b+"buttonup",this._buttonListener),this},changeButtonState:function(a,b){this.keyboardInputManager.changeState(a,b)},getElapsedTime:function(){return this.frame/this.fps}}),c.Core._loadFuncs={},c.Core._loadFuncs.jpg=c.Core._loadFuncs.jpeg=c.Core._loadFuncs.gif=c.Core._loadFuncs.png=c.Core._loadFuncs.bmp=function(a,b,d,e){return c.Surface.load(a,d,e)},c.Core._loadFuncs.mp3=c.Core._loadFuncs.aac=c.Core._loadFuncs.m4a=c.Core._loadFuncs.wav=c.Core._loadFuncs.ogg=function(a,b,d,e){return c.Sound.load(a,"audio/"+b,d,e)},c.Core.findExt=function(a){var b=a.match(/\.\w+$/);return b&&b.length>0?b[0].slice(1).toLowerCase():0===a.indexOf("data:")?a.split(/[\/;]/)[1].toLowerCase():null},c.Core.instance=null}(),c.Game=c.Core,c.InputManager=c.Class.create(c.EventTarget,{initialize:function(a,b){c.EventTarget.call(this),this.broadcastTarget=[],this.valueStore=a,this.source=b||this,this._binds={},this._stateHandler=function(a){var b=a.source.identifier,c=this._binds[b];this.changeState(c,a.data)}.bind(this)},bind:function(a,b){a.addEventListener(c.Event.INPUT_STATE_CHANGED,this._stateHandler),this._binds[a.identifier]=b},unbind:function(a){a.removeEventListener(c.Event.INPUT_STATE_CHANGED,this._stateHandler),delete this._binds[a.identifier]},addBroadcastTarget:function(a){var b=this.broadcastTarget.indexOf(a);b===-1&&this.broadcastTarget.push(a)},removeBroadcastTarget:function(a){var b=this.broadcastTarget.indexOf(a);b!==-1&&this.broadcastTarget.splice(b,1)},broadcastEvent:function(a){for(var b=this.broadcastTarget,c=0,d=b.length;c<d;c++)b[c].dispatchEvent(a)},changeState:function(a,b){}}),c.InputSource=c.Class.create(c.EventTarget,{initialize:function(a){c.EventTarget.call(this),this.identifier=a},notifyStateChange:function(a){var b=new c.Event(c.Event.INPUT_STATE_CHANGED);b.data=a,b.source=this,this.dispatchEvent(b)}}),c.BinaryInputManager=c.Class.create(c.InputManager,{initialize:function(a,b,d,e){c.InputManager.call(this,a,e),this.activeInputsNum=0,this.activeEventNameSuffix=b,this.inactiveEventNameSuffix=d},bind:function(a,b){c.InputManager.prototype.bind.call(this,a,b),this.valueStore[b]=!1},unbind:function(a){var b=this._binds[a.identifier];c.InputManager.prototype.unbind.call(this,a),delete this.valueStore[b]},changeState:function(a,b){b?this._down(a):this._up(a)},_down:function(a){var b;this.valueStore[a]||(this.valueStore[a]=!0,b=new c.Event(this.activeInputsNum++?"inputchange":"inputstart"),b.source=this.source,this.broadcastEvent(b));var d=new c.Event(a+this.activeEventNameSuffix);d.source=this.source,this.broadcastEvent(d)},_up:function(a){var b;this.valueStore[a]&&(this.valueStore[a]=!1,b=new c.Event(--this.activeInputsNum?"inputchange":"inputend"),b.source=this.source,this.broadcastEvent(b));var d=new c.Event(a+this.inactiveEventNameSuffix);d.source=this.source,this.broadcastEvent(d)}}),c.BinaryInputSource=c.Class.create(c.InputSource,{initialize:function(a){c.InputSource.call(this,a)}}),c.KeyboardInputManager=c.Class.create(c.BinaryInputManager,{initialize:function(a,b){c.BinaryInputManager.call(this,b,"buttondown","buttonup"),this._attachDOMEvent(a,"keydown",!0),this._attachDOMEvent(a,"keyup",!1)},keybind:function(a,b){this.bind(c.KeyboardInputSource.getByKeyCode(""+a),b)},keyunbind:function(a){this.unbind(c.KeyboardInputSource.getByKeyCode(""+a))},_attachDOMEvent:function(a,b,d){a.addEventListener(b,function(a){var b=c.Core.instance;if(b&&b.running){var e=a.keyCode,f=c.KeyboardInputSource._instances[e];f&&f.notifyStateChange(d)}},!0)}}),c.KeyboardInputSource=c.Class.create(c.BinaryInputSource,{initialize:function(a){c.BinaryInputSource.call(this,a)}}),c.KeyboardInputSource._instances={},c.KeyboardInputSource.getByKeyCode=function(a){return this._instances[a]||(this._instances[a]=new c.KeyboardInputSource(a)),this._instances[a]},c.Node=c.Class.create(c.EventTarget,{initialize:function(){c.EventTarget.call(this),this._dirty=!1,this._matrix=[1,0,0,1,0,0],this._x=0,this._y=0,this._offsetX=0,this._offsetY=0,this.age=0,this.parentNode=null,this.scene=null,this.addEventListener("touchstart",function(a){this.parentNode&&this.parentNode.dispatchEvent(a)}),this.addEventListener("touchmove",function(a){this.parentNode&&this.parentNode.dispatchEvent(a)}),this.addEventListener("touchend",function(a){this.parentNode&&this.parentNode.dispatchEvent(a)}),c.ENV.USE_ANIMATION&&(this.tl=new c.Timeline(this))},moveTo:function(a,b){this.x=a,this.y=b},moveBy:function(a,b){this.x+=a,this.y+=b},x:{get:function(){return this._x},set:function(a){this._x!==a&&(this._x=a,this._dirty=!0)}},y:{get:function(){return this._y},set:function(a){this._y!==a&&(this._y=a,this._dirty=!0)}},_updateCoordinate:function(){var a=this,b=[a],d=a.parentNode;for(this.scene;d&&a._dirty;)b.unshift(d),a=a.parentNode,d=a.parentNode;var e,f,g,h=c.Matrix.instance,i=h.stack,j=[];i.push(b[0]._matrix);for(var k=1,l=b.length;k<l;k++){a=b[k],e=[],h.makeTransformMatrix(a,j),h.multiply(i[i.length-1],j,e),a._matrix=e,i.push(e),f="number"==typeof a._originX?a._originX:a._width/2||0,g="number"==typeof a._originY?a._originY:a._height/2||0;var m=[f,g];h.multiplyVec(e,m,m),a._offsetX=m[0]-f,a._offsetY=m[1]-g,a._dirty=!1}h.reset()},remove:function(){if(this.parentNode&&this.parentNode.removeChild(this),this.childNodes)for(var a=this.childNodes.slice(),b=a.length-1;b>=0;b--)a[b].remove();this.clearEventListener()}});var d=function(a,b){for(var c,d=[],e=0,f=a.collection.length;e<f;e++)c=a.collection[e],b._intersectOne(c)&&d.push(c);return d},e=function(a,b){for(var c,d,e=[],f=0,g=a.collection.length;f<g;f++){c=a.collection[f];for(var h=0,i=b.collection.length;h<i;h++)d=b.collection[h],c._intersectOne(d)&&e.push([c,d])}return e},f=function(a,b){for(var c,d=[],e=0,f=a.collection.length;e<f;e++)c=a.collection[e],b._intersectStrictOne(c)&&d.push(c);return d},g=function(a,b){for(var c,d,e=[],f=0,g=a.collection.length;f<g;f++){c=a.collection[f];for(var h=0,i=b.collection.length;h<i;h++)d=b.collection[h],c._intersectStrictOne(d)&&e.push([c,d])}return e},h=function(a){return a instanceof c.Entity?d(this,a):!("function"!=typeof a||!a.collection)&&e(this,a)},i=function(a){return a instanceof c.Entity?f(this,a):!("function"!=typeof a||!a.collection)&&g(this,a)},j=c.Node.prototype.clearEventListener;c.Entity=c.Class.create(c.Node,{initialize:function(){var a=c.Core.instance;c.Node.call(this),this._rotation=0,this._scaleX=1,this._scaleY=1,this._touchEnabled=!0,this._clipping=!1,this._originX=null,this._originY=null,this._width=0,this._height=0,this._backgroundColor=null,this._debugColor="#0000ff",this._opacity=1,this._visible=!0,this._buttonMode=null,this._style={},this.__styleStatus={},this._isContainedInCollection=!1,this.compositeOperation=null,this.buttonMode=null,this.buttonPressed=!1,this.addEventListener("touchstart",function(){this.buttonMode&&(this.buttonPressed=!0,this.dispatchEvent(new c.Event(this.buttonMode+"buttondown")),a.changeButtonState(this.buttonMode,!0))}),this.addEventListener("touchend",function(){this.buttonMode&&(this.buttonPressed=!1,this.dispatchEvent(new c.Event(this.buttonMode+"buttonup")),a.changeButtonState(this.buttonMode,!1))}),this.enableCollection()},width:{get:function(){return this._width},set:function(a){this._width!==a&&(this._width=a,this._dirty=!0)}},height:{get:function(){return this._height},set:function(a){this._height!==a&&(this._height=a,this._dirty=!0)}},backgroundColor:{get:function(){return this._backgroundColor},set:function(a){this._backgroundColor=a}},debugColor:{get:function(){return this._debugColor},set:function(a){this._debugColor=a}},opacity:{get:function(){return this._opacity},set:function(a){this._opacity=parseFloat(a)}},visible:{get:function(){return this._visible},set:function(a){this._visible=a}},touchEnabled:{get:function(){return this._touchEnabled},set:function(a){this._touchEnabled=a,a?this._style.pointerEvents="all":this._style.pointerEvents="none"}},intersect:function(a){return a instanceof c.Entity?this._intersectOne(a):!("function"!=typeof a||!a.collection)&&d(a,this)},_intersectOne:function(a){return this._dirty&&this._updateCoordinate(),a._dirty&&a._updateCoordinate(),this._offsetX<a._offsetX+a.width&&a._offsetX<this._offsetX+this.width&&this._offsetY<a._offsetY+a.height&&a._offsetY<this._offsetY+this.height},intersectStrict:function(a){return a instanceof c.Entity?this._intersectStrictOne(a):!("function"!=typeof a||!a.collection)&&f(a,this)},_intersectStrictOne:function(a){this._dirty&&this._updateCoordinate(),a._dirty&&a._updateCoordinate();var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=this.getOrientedBoundingRect(),z=a.getOrientedBoundingRect(),A=y.leftTop,B=y.rightTop,C=y.leftBottom,D=y.rightBottom,E=z.leftTop,F=z.rightTop,G=z.leftBottom,H=z.rightBottom,I=A[0],J=A[1],K=B[0],L=B[1],M=C[0],N=C[1],O=D[0],P=D[1],Q=E[0],R=E[1],S=F[0],T=F[1],U=G[0],V=G[1],W=H[0],X=H[1],Y=[K-I,L-J],Z=[O-K,P-L],$=[M-O,N-P],_=[I-M,J-N],aa=[S-Q,T-R],ba=[W-S,X-T],ca=[U-W,V-X],da=[Q-U,R-V],ea=I+K+M+O>>2,fa=J+L+N+P>>2,ga=Q+S+U+W>>2,ha=R+T+V+X>>2;if(Y[0]*(ha-J)-Y[1]*(ga-I)>0&&Z[0]*(ha-L)-Z[1]*(ga-K)>0&&$[0]*(ha-P)-$[1]*(ga-O)>0&&_[0]*(ha-N)-_[1]*(ga-M)>0)return!0;if(aa[0]*(fa-R)-aa[1]*(ea-Q)>0&&ba[0]*(fa-T)-ba[1]*(ea-S)>0&&ca[0]*(fa-X)-ca[1]*(ea-W)>0&&da[0]*(fa-V)-da[1]*(ea-U)>0)return!0;for(d=[A,B,D,C],e=[E,F,H,G],f=[Y,Z,$,_],g=[aa,ba,ca,da],b=0;b<4;b++)for(h=d[b],l=h[0],m=h[1],j=f[b],p=j[0],q=j[1],c=0;c<4;c++)if(i=e[c],n=i[0],o=i[1],k=g[c],r=k[0],s=k[1],v=p*s-q*r,0!==v&&(t=n-l,u=o-m,w=(t*q-u*p)/v,x=(t*s-u*r)/v,0<w&&w<1&&0<x&&x<1))return!0;return!1},within:function(a,b){this._dirty&&this._updateCoordinate(),a._dirty&&a._updateCoordinate(),null==b&&(b=(this.width+this.height+a.width+a.height)/4);var c;return(c=this._offsetX-a._offsetX+(this.width-a.width)/2)*c+(c=this._offsetY-a._offsetY+(this.height-a.height)/2)*c<b*b},scale:function(a,b){this._scaleX*=a,this._scaleY*=null!=b?b:a,this._dirty=!0},rotate:function(a){this.rotation+=a},scaleX:{get:function(){return this._scaleX},set:function(a){this._scaleX!==a&&(this._scaleX=a,this._dirty=!0)}},scaleY:{get:function(){return this._scaleY},set:function(a){this._scaleY!==a&&(this._scaleY=a,this._dirty=!0)}},rotation:{get:function(){return this._rotation},set:function(a){this._rotation!==a&&(this._rotation=a,this._dirty=!0)}},originX:{get:function(){return this._originX},set:function(a){this._originX!==a&&(this._originX=a,this._dirty=!0)}},originY:{get:function(){return this._originY},set:function(a){this._originY!==a&&(this._originY=a,this._dirty=!0)}},enableCollection:function(){this.addEventListener("addedtoscene",this._addSelfToCollection),this.addEventListener("removedfromscene",this._removeSelfFromCollection),this.scene&&this._addSelfToCollection()},disableCollection:function(){this.removeEventListener("addedtoscene",this._addSelfToCollection),this.removeEventListener("removedfromscene",this._removeSelfFromCollection),this.scene&&this._removeSelfFromCollection()},clearEventListener:function(){j.apply(this,arguments),this.scene&&this._removeSelfFromCollection()},_addSelfToCollection:function(){if(!this._isContainedInCollection){var a=this.getConstructor();a._collectionTarget.forEach(function(a){a.collection.push(this)},this),this._isContainedInCollection=!0}},_removeSelfFromCollection:function(){if(this._isContainedInCollection){var a=this.getConstructor();a._collectionTarget.forEach(function(a){var b=a.collection.indexOf(this);b!==-1&&a.collection.splice(b,1)},this),this._isContainedInCollection=!1}},getBoundingRect:function(){var a=this.width||0,b=this.height||0,c=this._matrix,d=c[0]*a,e=c[1]*a,f=c[2]*b,g=c[3]*b,h=c[4],i=c[5],j=[h,d+h,f+h,d+f+h].sort(function(a,b){return a-b}),k=[i,e+i,g+i,e+g+i].sort(function(a,b){return a-b});return{left:j[0],top:k[0],width:j[3]-j[0],height:k[3]-k[0]}},getOrientedBoundingRect:function(){var a=this.width||0,b=this.height||0,c=this._matrix,d=c[0]*a,e=c[1]*a,f=c[2]*b,g=c[3]*b,h=c[4],i=c[5];return{leftTop:[h,i],rightTop:[d+h,e+i],leftBottom:[f+h,g+i],rightBottom:[d+f+h,e+g+i]}},getConstructor:function(){return Object.getPrototypeOf(this).constructor}});var k=function(a){if(!a._collective){var b=c.Class.getInheritanceTree(a),d=b.indexOf(c.Entity);d!==-1?a._collectionTarget=b.splice(0,d+1):a._collectionTarget=[],a.intersect=h,a.intersectStrict=i,a.collection=[],a._collective=!0}};k(c.Entity),c.Entity._inherited=function(a){k(a)},c.Sprite=c.Class.create(c.Entity,{initialize:function(a,b){c.Entity.call(this),this.width=a,this.height=b,this._image=null,this._debugColor="#ff0000",this._frameLeft=0,this._frameTop=0,this._frame=0,this._frameSequence=null},image:{get:function(){return this._image},set:function(a){if(a===b)throw new Error("Assigned value on Sprite.image is undefined. Please double-check image path, and check if the image you want to use is preload before use.");a!==this._image&&(this._image=a,this._computeFramePosition())}},frame:{get:function(){return this._frame},set:function(a){null==this._frameSequence&&this._frame===a||this._deepCompareToPreviousFrame(a)||(a instanceof Array?this._frameSequence=a:(this._frameSequence=null,this._frame=a,this._computeFramePosition()))}},_frameSequence:{get:function(){return this.__frameSequence},set:function(a){a&&!this.__frameSequence?this.addEventListener(c.Event.ENTER_FRAME,this._rotateFrameSequence):!a&&this.__frameSequence&&this.removeEventListener(c.Event.ENTER_FRAME,this._rotateFrameSequence),a?(this.__frameSequence=a.slice(),this._originalFrameSequence=a.slice(),this._rotateFrameSequence()):(this.__frameSequence=null,this._originalFrameSequence=null)}},_deepCompareToPreviousFrame:function(a){if(a===this._originalFrameSequence)return!0;if(null==a||null==this._originalFrameSequence)return!1;if(!(a instanceof Array))return!1;if(a.length!==this._originalFrameSequence.length)return!1;
for(var b=0;b<a.length;++b)if(a[b]!==this._originalFrameSequence[b])return!1;return!0},_computeFramePosition:function(){var a,b=this._image;null!=b&&(a=b.width/this._width|0,this._frameLeft=(this._frame%a|0)*this._width,this._frameTop=(this._frame/a|0)*this._height%b.height)},_rotateFrameSequence:function(){var a=this._frameSequence;if(a&&0!==a.length){var b=a.shift();null===b?(this._frameSequence=null,this.dispatchEvent(new c.Event(c.Event.ANIMATION_END))):(this._frame=b,this._computeFramePosition(),a.push(b))}},width:{get:function(){return this._width},set:function(a){this._width=a,this._computeFramePosition(),this._dirty=!0}},height:{get:function(){return this._height},set:function(a){this._height=a,this._computeFramePosition(),this._dirty=!0}},cvsRender:function(a){var b,d,e,f,g,h,i,j=this._image,k=this._width,l=this._height;j&&0!==k&&0!==l&&(b=j.width,d=j.height,b<k||d<l?(a.fillStyle=c.Surface._getPattern(j),a.fillRect(0,0,k,l)):(e=j._element,f=this._frameLeft,g=Math.min(this._frameTop,d-l),h=Math.max(.01,Math.min(b-f,k)),i=Math.max(.01,Math.min(d-g,l)),a.drawImage(e,f,g,h,i,0,0,k,l)))},domRender:function(){return"ms"===c.ENV.VENDOR_PREFIX?function(a){this._image&&(this._image._css?(this._style["background-image"]=this._image._css,this._style["background-position"]=-this._frameLeft+"px "+-this._frameTop+"px"):this._image._element)}:function(a){this._image&&(this._image._css?(this._style["background-image"]=this._image._css,this._style["background-position"]=-this._frameLeft+"px "+-this._frameTop+"px"):this._image._element)}}()}),c.Label=c.Class.create(c.Entity,{initialize:function(a){c.Entity.call(this),this.text=a||"",this.width=300,this.font="14px serif",this.textAlign="left",this._debugColor="#ff0000"},width:{get:function(){return this._width},set:function(a){this._width=a,this._dirty=!0,this.updateBoundArea()}},text:{get:function(){return this._text},set:function(a){if(a=""+a,this._text!==a){this._text=a,a=a.replace(/<br ?\/?>/gi,"<br/>"),this._splitText=a.split("<br/>"),this.updateBoundArea();for(var b=0,c=this._splitText.length;b<c;b++){a=this._splitText[b];var d=this.getMetrics(a);this._splitText[b]={},this._splitText[b].text=a,this._splitText[b].height=d.height,this._splitText[b].width=d.width}}}},textAlign:{get:function(){return this._style["text-align"]},set:function(a){this._style["text-align"]=a,this.updateBoundArea()}},font:{get:function(){return this._style.font},set:function(a){this._style.font=a,this.updateBoundArea()}},color:{get:function(){return this._style.color},set:function(a){this._style.color=a}},cvsRender:function(a){var b,c,d,e,f,g,h,i,j,k=0,l=this.width;if(this._splitText){a.textBaseline="top",a.font=this.font,a.fillStyle=this.color||"#000000",c=a.measureText(" ").width,d=l/c;for(var m=0,n=this._splitText.length;m<n;m++){for(e=this._splitText[m],f=e.text,g=0;f.length>g+d||a.measureText(f.slice(g,g+d)).width>l;){for(h="",i=d,j=0;i>0;)a.measureText(h).width<l?(j+=i,h=f.slice(g,g+j)):(j-=i,h=f.slice(g,g+j)),i=i/2|0;a.fillText(h,0,k),k+=e.height-1,g+=j}h=f.slice(g,g+f.length),b="right"===this.textAlign?l-a.measureText(h).width:"center"===this.textAlign?(l-a.measureText(h).width)/2:0,a.fillText(h,b,k),k+=e.height-1}}},domRender:function(a){a.innerHTML!==this._text&&(a.innerHTML=this._text)},detectRender:function(a){a.fillRect(this._boundOffset,0,this._boundWidth,this._boundHeight)},updateBoundArea:function(){var a=this.getMetrics();this._boundWidth=a.width,this._boundHeight=a.height,"right"===this.textAlign?this._boundOffset=this.width-this._boundWidth:"center"===this.textAlign?this._boundOffset=(this.width-this._boundWidth)/2:this._boundOffset=0},getMetrics:function(a){var b,c={};if(document.body){b=document.createElement("div");for(var d in this._style)"width"!==d&&"height"!==d&&(b.style[d]=this._style[d]);a=a||this._text,b.innerHTML=a.replace(/ /g,"&nbsp;"),b.style.whiteSpace="noWrap",b.style.lineHeight=1,document.body.appendChild(b);var e=getComputedStyle(b);c.height=parseInt(e.height,10)+1,b.style.position="absolute",c.width=parseInt(e.width,10)+1,document.body.removeChild(b)}else c.width=this.width,c.height=this.height;return c}}),c.Map=c.Class.create(c.Entity,{initialize:function(a,b){var d=c.Core.instance;c.Entity.call(this);var e=new c.Surface(d.width,d.height);this._surface=e;var f=e._element;f.style.position="absolute",c.ENV.RETINA_DISPLAY&&2===d.scale?(f.width=2*d.width,f.height=2*d.height,this._style.webkitTransformOrigin="0 0",this._style.webkitTransform="scale(0.5)"):(f.width=d.width,f.height=d.height),this._context=f.getContext("2d"),this._tileWidth=a||0,this._tileHeight=b||0,this._image=null,this._data=[[[]]],this._dirty=!1,this._tight=!1,this.touchEnabled=!1,this.collisionData=null,this._listeners.render=null,this.addEventListener("render",function(){this._dirty&&(this._previousOffsetX=this._previousOffsetY=null)})},loadData:function(a){this._data=Array.prototype.slice.apply(arguments),this._dirty=!0,this._tight=!1;for(var b=0,c=this._data.length;b<c;b++){var d=0;a=this._data[b];for(var e=0,f=a.length;e<f;e++)for(var g=0,h=a[e].length;g<h;g++)a[e][g]>=0&&d++;if(d/(a.length*a[0].length)>.2){this._tight=!0;break}}},checkTile:function(a,b){if(a<0||this.width<=a||b<0||this.height<=b)return!1;var c=this._image.width,d=this._image.height,e=this._tileWidth||c,f=this._tileHeight||d;a=a/e|0,b=b/f|0;var g=this._data[0];return g[b][a]},hitTest:function(a,b){if(a<0||this.width<=a||b<0||this.height<=b)return!1;var c=this._image.width,d=this._image.height,e=this._tileWidth||c,f=this._tileHeight||d;if(a=a/e|0,b=b/f|0,null!=this.collisionData)return this.collisionData[b]&&!!this.collisionData[b][a];for(var g=0,h=this._data.length;g<h;g++){var i,j=this._data[g];if(null!=j[b]&&null!=(i=j[b][a])&&0<=i&&i<(c/e|0)*(d/f|0))return!0}return!1},image:{get:function(){return this._image},set:function(a){var b=c.Core.instance;if(this._image=a,c.ENV.RETINA_DISPLAY&&2===b.scale){for(var d=new c.Surface(2*a.width,2*a.height),e=this._tileWidth||a.width,f=this._tileHeight||a.height,g=a.width/e|0,h=a.height/f|0,i=0;i<h;i++)for(var j=0;j<g;j++)d.draw(a,j*e,i*f,e,f,j*e*2,i*f*2,2*e,2*f);this._doubledImage=d}this._dirty=!0}},tileWidth:{get:function(){return this._tileWidth},set:function(a){this._tileWidth!==a&&(this._tileWidth=a,this._dirty=!0)}},tileHeight:{get:function(){return this._tileHeight},set:function(a){this._tileHeight!==a&&(this._tileHeight=a,this._dirty=!0)}},width:{get:function(){return this._tileWidth*this._data[0][0].length}},height:{get:function(){return this._tileHeight*this._data[0].length}},redraw:function(a,b,c,d){if(null!=this._image){var e,f,g,h,i;this._doubledImage?(e=this._doubledImage,f=2*this._tileWidth,g=2*this._tileHeight,h=2*-this._offsetX,i=2*-this._offsetY,a*=2,b*=2,c*=2,d*=2):(e=this._image,f=this._tileWidth,g=this._tileHeight,h=-this._offsetX,i=-this._offsetY);var j=e.width/f|0,k=e.height/g|0,l=Math.max((a+h)/f|0,0),m=Math.max((b+i)/g|0,0),n=Math.ceil((a+h+c)/f),o=Math.ceil((b+i+d)/g),p=e._element,q=this._context;q.canvas;q.clearRect(a,b,c,d);for(var r=0,s=this._data.length;r<s;r++){var t=this._data[r],u=Math.min(n,t[0].length),v=Math.min(o,t.length);for(b=m;b<v;b++)for(a=l;a<u;a++){var w=t[b][a];if(0<=w&&w<j*k){var x=w%j*f,y=(w/j|0)*g;q.drawImage(p,x,y,f,g,a*f-h,b*g-i,f,g)}}}}},updateBuffer:function(){if(this._visible===b||this._visible){var a=c.Core.instance;if(this._dirty||null==this._previousOffsetX)this.redraw(0,0,a.width,a.height);else if(this._offsetX!==this._previousOffsetX||this._offsetY!==this._previousOffsetY)if(this._tight){var d=-this._offsetX,e=-this._offsetY,f=-this._previousOffsetX,g=-this._previousOffsetY,h=d-f+a.width,i=f-d+a.width,j=e-g+a.height,k=g-e+a.height;if(h>this._tileWidth&&i>this._tileWidth&&j>this._tileHeight&&k>this._tileHeight){var l,m,n,o,p,q;h<i?(l=0,n=f-d,p=h):(l=d-f,n=0,p=i),j<k?(m=0,o=g-e,q=j):(m=e-g,o=0,q=k),null==a._buffer&&(a._buffer=document.createElement("canvas"),a._buffer.width=this._context.canvas.width,a._buffer.height=this._context.canvas.height);var r=a._buffer.getContext("2d");this._doubledImage?(r.clearRect(0,0,2*p,2*q),r.drawImage(this._context.canvas,2*l,2*m,2*p,2*q,0,0,2*p,2*q),r=this._context,r.clearRect(2*n,2*o,2*p,2*q),r.drawImage(a._buffer,0,0,2*p,2*q,2*n,2*o,2*p,2*q)):(r.clearRect(0,0,p,q),r.drawImage(this._context.canvas,l,m,p,q,0,0,p,q),r=this._context,r.clearRect(n,o,p,q),r.drawImage(a._buffer,0,0,p,q,n,o,p,q)),0===n?this.redraw(p,0,a.width-p,a.height):this.redraw(0,0,a.width-p,a.height),0===o?this.redraw(0,q,a.width,a.height-q):this.redraw(0,0,a.width,a.height-q)}else this.redraw(0,0,a.width,a.height)}else this.redraw(0,0,a.width,a.height);this._previousOffsetX=this._offsetX,this._previousOffsetY=this._offsetY}},cvsRender:function(a){if(0!==this.width&&0!==this.height){var b=c.Core.instance;this.updateBuffer(),a.save(),a.setTransform(1,0,0,1,0,0);var d=this._context.canvas;a.drawImage(d,0,0,b.width,b.height),a.restore()}},domRender:function(a){this._image&&(this.updateBuffer(),this._style["background-image"]=this._surface._css,this._style[c.ENV.VENDOR_PREFIX+"Transform"]="matrix(1, 0, 0, 1, 0, 0)")}}),c.Group=c.Class.create(c.Node,{initialize:function(){this.childNodes=[],c.Node.call(this),this._rotation=0,this._scaleX=1,this._scaleY=1,this._originX=null,this._originY=null,this.__dirty=!1,[c.Event.ADDED_TO_SCENE,c.Event.REMOVED_FROM_SCENE].forEach(function(a){this.addEventListener(a,function(a){this.childNodes.forEach(function(b){b.scene=this.scene,b.dispatchEvent(a)},this)})},this)},addChild:function(a){a.parentNode&&a.parentNode.removeChild(a),this.childNodes.push(a),a.parentNode=this;var b=new c.Event("childadded");if(b.node=a,b.next=null,this.dispatchEvent(b),a.dispatchEvent(new c.Event("added")),this.scene){a.scene=this.scene;var d=new c.Event("addedtoscene");a.dispatchEvent(d)}},insertBefore:function(a,b){a.parentNode&&a.parentNode.removeChild(a);var d=this.childNodes.indexOf(b);if(d!==-1){this.childNodes.splice(d,0,a),a.parentNode=this;var e=new c.Event("childadded");if(e.node=a,e.next=b,this.dispatchEvent(e),a.dispatchEvent(new c.Event("added")),this.scene){a.scene=this.scene;var f=new c.Event("addedtoscene");a.dispatchEvent(f)}}else this.addChild(a)},removeChild:function(a){var b;if((b=this.childNodes.indexOf(a))!==-1){this.childNodes.splice(b,1),a.parentNode=null;var d=new c.Event("childremoved");if(d.node=a,this.dispatchEvent(d),a.dispatchEvent(new c.Event("removed")),this.scene){a.scene=null;var e=new c.Event("removedfromscene");a.dispatchEvent(e)}}},firstChild:{get:function(){return this.childNodes[0]}},lastChild:{get:function(){return this.childNodes[this.childNodes.length-1]}},rotation:{get:function(){return this._rotation},set:function(a){this._rotation!==a&&(this._rotation=a,this._dirty=!0)}},scaleX:{get:function(){return this._scaleX},set:function(a){this._scaleX!==a&&(this._scaleX=a,this._dirty=!0)}},scaleY:{get:function(){return this._scaleY},set:function(a){this._scaleY!==a&&(this._scaleY=a,this._dirty=!0)}},originX:{get:function(){return this._originX},set:function(a){this._originX!==a&&(this._originX=a,this._dirty=!0)}},originY:{get:function(){return this._originY},set:function(a){this._originY!==a&&(this._originY=a,this._dirty=!0)}},_dirty:{get:function(){return this.__dirty},set:function(a){if(a=!!a,this.__dirty=a,a)for(var b=0,c=this.childNodes.length;b<c;b++)this.childNodes[b]._dirty=!0}}}),c.Matrix=c.Class.create({initialize:function(){this.reset()},reset:function(){this.stack=[],this.stack.push([1,0,0,1,0,0])},makeTransformMatrix:function(a,b){var c=a._x,d=a._y,e=a.width||0,f=a.height||0,g=a._rotation||0,h="number"==typeof a._scaleX?a._scaleX:1,i="number"==typeof a._scaleY?a._scaleY:1,j=g*Math.PI/180,k=Math.cos(j),l=Math.sin(j),m="number"==typeof a._originX?a._originX:e/2,n="number"==typeof a._originY?a._originY:f/2,o=h*k,p=h*l,q=i*l,r=i*k;b[0]=o,b[1]=p,b[2]=-q,b[3]=r,b[4]=-o*m+q*n+c+m,b[5]=-p*m-r*n+d+n},multiply:function(a,b,c){var d=a[0],e=a[2],f=a[4],g=a[1],h=a[3],i=a[5],j=b[0],k=b[2],l=b[4],m=b[1],n=b[3],o=b[5];c[0]=d*j+e*m,c[1]=g*j+h*m,c[2]=d*k+e*n,c[3]=g*k+h*n,c[4]=d*l+e*o+f,c[5]=g*l+h*o+i},multiplyVec:function(a,b,c){var d=b[0],e=b[1],f=a[0],g=a[2],h=a[4],i=a[1],j=a[3],k=a[5];c[0]=f*d+g*e+h,c[1]=i*d+j*e+k}}),c.Matrix.instance=new c.Matrix,c.DetectColorManager=c.Class.create({initialize:function(a,b){this.reference=[],this.colorResolution=a||16,this.max=b||1,this.capacity=Math.pow(this.colorResolution,3);for(var c=1,d=this.capacity;c<d;c++)this.reference[c]=null},attachDetectColor:function(a){var b=this.reference.indexOf(null);return b===-1&&(b=1),this.reference[b]=a,this._getColor(b)},detachDetectColor:function(a){var b=this.reference.indexOf(a);b!==-1&&(this.reference[b]=null)},_getColor:function(a){var b=this.colorResolution,c=b/this.max;return[parseInt(a/b/b%b,10)/c,parseInt(a/b%b,10)/c,parseInt(a%b,10)/c,1]},_decodeDetectColor:function(a,b){b=b||0;var c=this.colorResolution;return~~(a[b]*c*c*c/256)+~~(a[b+1]*c*c/256)+~~(a[b+2]*c/256)},getSpriteByColor:function(a){return this.reference[this._decodeDetectColor(a)]},getSpriteByColors:function(a){var b,c,d,e,f=0,g={};for(b=0,c=a.length;b<c;b+=4)d=this._decodeDetectColor(a,b),g[d]=(g[d]||0)+1;for(d in g)g[d]>f&&(f=g[d],e=d);return this.reference[e]}}),c.DomManager=c.Class.create({initialize:function(a,b){var d=c.Core.instance;this.layer=null,this.targetNode=a,"string"==typeof b?this.element=document.createElement(b):b instanceof HTMLElement&&(this.element=b),this.style=this.element.style,this.style.position="absolute",this.style[c.ENV.VENDOR_PREFIX+"TransformOrigin"]="0px 0px",d._debug&&(this.style.border="1px solid blue",this.style.margin="-1px");var e=this;this._setDomTarget=function(){e.layer._touchEventTarget=e.targetNode},this._attachEvent()},getDomElement:function(){return this.element},getDomElementAsNext:function(){return this.element},getNextManager:function(a){var b=this.targetNode.parentNode.childNodes.indexOf(a.targetNode);return b!==this.targetNode.parentNode.childNodes.length-1?this.targetNode.parentNode.childNodes[b+1]._domManager:null},addManager:function(a,b){var c;b&&(c=b.getDomElementAsNext());var d=a.getDomElement();d instanceof Array?d.forEach(function(a){c?this.element.insertBefore(a,c):this.element.appendChild(a)},this):c?this.element.insertBefore(d,c):this.element.appendChild(d),this.setLayer(this.layer)},removeManager:function(a){a instanceof c.DomlessManager?a._domRef.forEach(function(a){this.element.removeChild(a)},this):this.element.removeChild(a.element),this.setLayer(this.layer)},setLayer:function(a){this.layer=a;var b,c=this.targetNode;if(c.childNodes)for(var d=0,e=c.childNodes.length;d<e;d++)b=c.childNodes[d]._domManager,b&&b.setLayer(a)},render:function(a){var b=this.targetNode,d=c.Matrix.instance,e=d.stack,f=[];d.makeTransformMatrix(b,f),d.multiply(e[e.length-1],f,f),d.multiply(a,f,a),b._matrix=a;var g="number"==typeof b._originX?b._originX:b.width/2||0,h="number"==typeof b._originY?b._originY:b.height/2||0,i=[g,h];d.multiplyVec(f,i,i),b._offsetX=i[0]-g,b._offsetY=i[1]-h,!b.parentNode||b.parentNode instanceof c.Group||(b._offsetX+=b.parentNode._offsetX,b._offsetY+=b.parentNode._offsetY),b._dirty&&(this.style[c.ENV.VENDOR_PREFIX+"Transform"]="matrix("+f[0].toFixed(10)+","+f[1].toFixed(10)+","+f[2].toFixed(10)+","+f[3].toFixed(10)+","+f[4].toFixed(10)+","+f[5].toFixed(10)+")"),this.domRender()},domRender:function(){var a=this.targetNode;a._style||(a._style={}),a.__styleStatus||(a.__styleStatus={}),null!==a.width&&(a._style.width=a.width+"px"),null!==a.height&&(a._style.height=a.height+"px"),a._style.opacity=a._opacity,a._style["background-color"]=a._backgroundColor,"undefined"!=typeof a._visible&&(a._style.display=a._visible?"block":"none"),"function"==typeof a.domRender&&a.domRender(this.element);var b;for(var c in a._style)b=a._style[c],a.__styleStatus[c]!==b&&null!=b&&(this.style.setProperty(c,""+b),a.__styleStatus[c]=b)},_attachEvent:function(){c.ENV.TOUCH_ENABLED&&this.element.addEventListener("touchstart",this._setDomTarget,!0),this.element.addEventListener("mousedown",this._setDomTarget,!0)},_detachEvent:function(){c.ENV.TOUCH_ENABLED&&this.element.removeEventListener("touchstart",this._setDomTarget,!0),this.element.removeEventListener("mousedown",this._setDomTarget,!0)},remove:function(){this._detachEvent(),this.element=this.style=this.targetNode=null}}),c.DomlessManager=c.Class.create({initialize:function(a){this._domRef=[],this.targetNode=a},_register:function(a,b){var c=this._domRef.indexOf(b);a instanceof Array?c===-1?Array.prototype.push.apply(this._domRef,a):Array.prototype.splice.apply(this._domRef,[c,0].concat(a)):c===-1?this._domRef.push(a):this._domRef.splice(c,0,a)},getNextManager:function(a){var b=this.targetNode.parentNode.childNodes.indexOf(a.targetNode);return b!==this.targetNode.parentNode.childNodes.length-1?this.targetNode.parentNode.childNodes[b+1]._domManager:null},getDomElement:function(){var a=[];return this.targetNode.childNodes.forEach(function(b){a=a.concat(b._domManager.getDomElement())}),a},getDomElementAsNext:function(){if(this._domRef.length)return this._domRef[0];var a=this.getNextManager(this);return a?a.element:null},addManager:function(a,b){var d=this.targetNode.parentNode;d&&(null===b&&(b=this.getNextManager(this)),d instanceof c.Scene?d._layers.Dom._domManager.addManager(a,b):d._domManager.addManager(a,b));var e=b?b.getDomElementAsNext():null;this._register(a.getDomElement(),e),this.setLayer(this.layer)},removeManager:function(a){var b,c=this._domRef.indexOf(a.element);c!==-1&&(b=this._domRef[c],b.parentNode.removeChild(b),this._domRef.splice(c,1)),this.setLayer(this.layer)},setLayer:function(a){this.layer=a;var b,c=this.targetNode;if(c.childNodes)for(var d=0,e=c.childNodes.length;d<e;d++)b=c.childNodes[d]._domManager,b&&b.setLayer(a)},render:function(a){var b=c.Matrix.instance,d=b.stack,e=this.targetNode,f=[];b.makeTransformMatrix(e,f),b.multiply(d[d.length-1],f,f),b.multiply(a,f,a),e._matrix=a;var g="number"==typeof e._originX?e._originX:e.width/2||0,h="number"==typeof e._originY?e._originY:e.height/2||0,i=[g,h];b.multiplyVec(f,i,i),e._offsetX=i[0]-g,e._offsetY=i[1]-h,d.push(f)},remove:function(){this._domRef=[],this.targetNode=null}}),c.DomLayer=c.Class.create(c.Group,{initialize:function(){var a=c.Core.instance;c.Group.call(this),this._touchEventTarget=null,this._element=document.createElement("div"),this._element.style.position="absolute",this._domManager=new c.DomManager(this,this._element),this._domManager.layer=this,this.width=a.width,this.height=a.height;var b=[c.Event.TOUCH_START,c.Event.TOUCH_MOVE,c.Event.TOUCH_END];b.forEach(function(a){this.addEventListener(a,function(a){this._scene&&this._scene.dispatchEvent(a)})},this);var d=function(a){var b=a.node,f=a.next,g=a.target,h=f?f._domManager:null;c.DomLayer._attachDomManager(b,d,e),g._domManager.addManager(b._domManager,h);var i=new c.Event(c.Event.RENDER);b._dirty=!0,g._domManager.layer._rendering(b,i)},e=function(a){var b=a.node,f=a.target;f._domManager.removeManager(b._domManager),c.DomLayer._detachDomManager(b,d,e)};this.addEventListener("childremoved",e),this.addEventListener("childadded",d)},width:{get:function(){return this._width},set:function(a){this._width=a,this._element.style.width=a+"px"}},height:{get:function(){return this._height},set:function(a){this._height=a,this._element.style.height=a+"px"}},addChild:function(a){this.childNodes.push(a),a.parentNode=this;var b=new c.Event("childadded");if(b.node=a,b.next=null,this.dispatchEvent(b),a.dispatchEvent(new c.Event("added")),this.scene){a.scene=this.scene;var d=new c.Event("addedtoscene");a.dispatchEvent(d)}},insertBefore:function(a,b){var d=this.childNodes.indexOf(b);if(d!==-1){this.childNodes.splice(d,0,a),a.parentNode=this;var e=new c.Event("childadded");if(e.node=a,e.next=b,this.dispatchEvent(e),a.dispatchEvent(new c.Event("added")),this.scene){a.scene=this.scene;var f=new c.Event("addedtoscene");a.dispatchEvent(f)}}else this.addChild(a)},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe),this._onexitframe()},_stopRendering:function(){this.removeEventListener("exitframe",this._onexitframe),this._onexitframe()},_onexitframe:function(){this._rendering(this,new c.Event(c.Event.RENDER))},_rendering:function(a,b,d){var e;if(d||(d=[1,0,0,1,0,0]),a.dispatchEvent(b),a._domManager.render(d),a.childNodes)for(var f=0,g=a.childNodes.length;f<g;f++)e=a.childNodes[f],this._rendering(e,b,d.slice());a._domManager instanceof c.DomlessManager&&c.Matrix.instance.stack.pop(),a._dirty=!1},_determineEventTarget:function(){var a=this._touchEventTarget;return this._touchEventTarget=null,a===this?null:a}}),c.DomLayer._attachDomManager=function(a,b,d){var e;if(a._domManager||(a.addEventListener("childadded",b),a.addEventListener("childremoved",d),a instanceof c.Group?a._domManager=new c.DomlessManager(a):a._element?a._domManager=new c.DomManager(a,a._element):a._domManager=new c.DomManager(a,"div")),a.childNodes)for(var f=0,g=a.childNodes.length;f<g;f++)e=a.childNodes[f],c.DomLayer._attachDomManager(e,b,d),a._domManager.addManager(e._domManager,null)},c.DomLayer._detachDomManager=function(a,b,d){var e;if(a.removeEventListener("childadded",b),a.removeEventListener("childremoved",d),a.childNodes)for(var f=0,g=a.childNodes.length;f<g;f++)e=a.childNodes[f],a._domManager.removeManager(e._domManager,null),c.DomLayer._detachDomManager(e,b,d);a._domManager.remove(),delete a._domManager},c.CanvasLayer=c.Class.create(c.Group,{initialize:function(){var a=c.Core.instance;c.Group.call(this),this._cvsCache={matrix:[1,0,0,1,0,0],detectColor:"#000000"},this._cvsCache.layer=this,this._element=document.createElement("canvas"),this._element.style.position="absolute",this._element.style.left=this._element.style.top="0px",this._detect=document.createElement("canvas"),this._detect.style.position="absolute",this._lastDetected=0,this.context=this._element.getContext("2d"),this._dctx=this._detect.getContext("2d"),this._setImageSmoothingEnable(),this._colorManager=new c.DetectColorManager(16,256),this.width=a.width,this.height=a.height;var b=[c.Event.TOUCH_START,c.Event.TOUCH_MOVE,c.Event.TOUCH_END];b.forEach(function(a){this.addEventListener(a,function(a){this._scene&&this._scene.dispatchEvent(a)})},this);var d=function(a){var b,f=a.node,g=a.target;b=g instanceof c.CanvasLayer?g._scene._layers.Canvas:g.scene._layers.Canvas,c.CanvasLayer._attachCache(f,b,d,e);var h=new c.Event(c.Event.RENDER);g._dirty&&g._updateCoordinate(),f._dirty=!0,c.Matrix.instance.stack.push(g._matrix),c.CanvasRenderer.instance.render(b.context,f,h),c.Matrix.instance.stack.pop(g._matrix)},e=function(a){var b,f=a.node,g=a.target;b=g instanceof c.CanvasLayer?g._scene._layers.Canvas:g.scene._layers.Canvas,c.CanvasLayer._detachCache(f,b,d,e)};this.addEventListener("childremoved",e),this.addEventListener("childadded",d)},width:{get:function(){return this._width},set:function(a){this._width=a,this._element.width=this._detect.width=a,this._setImageSmoothingEnable()}},height:{get:function(){return this._height},set:function(a){this._height=a,this._element.height=this._detect.height=a,this._setImageSmoothingEnable()}},addChild:function(a){this.childNodes.push(a),a.parentNode=this;var b=new c.Event("childadded");b.node=a,b.next=null,this.dispatchEvent(b),a.dispatchEvent(new c.Event("added"))},insertBefore:function(a,b){var d=this.childNodes.indexOf(b);if(d!==-1){this.childNodes.splice(d,0,a),a.parentNode=this;var e=new c.Event("childadded");e.node=a,e.next=b,this.dispatchEvent(e),a.dispatchEvent(new c.Event("added"))}else this.addChild(a)},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe),this._onexitframe()},_stopRendering:function(){this.removeEventListener("exitframe",this._onexitframe),this._onexitframe()},_onexitframe:function(){var a=c.Core.instance,b=this.context;b.clearRect(0,0,a.width,a.height);var d=new c.Event(c.Event.RENDER);c.CanvasRenderer.instance.render(b,this,d)},_determineEventTarget:function(a){return this._getEntityByPosition(a.x,a.y)},_getEntityByPosition:function(a,b){var d=c.Core.instance,e=this._dctx;this._lastDetected<d.frame&&(e.clearRect(0,0,this.width,this.height),c.CanvasRenderer.instance.detectRender(e,this),this._lastDetected=d.frame);var f=c.ENV.COLOR_DETECTION_LEVEL-1,g=e.getImageData(a-f,b-f,1+2*f,1+2*f).data;return this._colorManager.getSpriteByColors(g)},_setImageSmoothingEnable:function(){this._dctx.imageSmoothingEnabled=this._dctx.msImageSmoothingEnabled=this._dctx.mozImageSmoothingEnabled=this._dctx.webkitImageSmoothingEnabled=!1}}),c.CanvasLayer._attachCache=function(a,b,d,e){var f;if(a._cvsCache||(a._cvsCache={},a._cvsCache.matrix=[1,0,0,1,0,0],a._cvsCache.detectColor="rgba("+b._colorManager.attachDetectColor(a)+")",a.addEventListener("childadded",d),a.addEventListener("childremoved",e)),a.childNodes)for(var g=0,h=a.childNodes.length;g<h;g++)f=a.childNodes[g],c.CanvasLayer._attachCache(f,b,d,e)},c.CanvasLayer._detachCache=function(a,b,d,e){var f;if(a._cvsCache&&(b._colorManager.detachDetectColor(a),a.removeEventListener("childadded",d),a.removeEventListener("childremoved",e),delete a._cvsCache),a.childNodes)for(var g=0,h=a.childNodes.length;g<h;g++)f=a.childNodes[g],c.CanvasLayer._detachCache(f,b,d,e)},c.CanvasRenderer=c.Class.create({render:function(a,b,d){var e,f,g;if(a.save(),b.dispatchEvent(d),this.transform(a,b),("undefined"==typeof b._visible||b._visible)&&(e=b.width,f=b.height,b.compositeOperation&&(a.globalCompositeOperation=b.compositeOperation),a.globalAlpha="number"==typeof b._opacity?b._opacity:1,b._backgroundColor&&(a.fillStyle=b._backgroundColor,a.fillRect(0,0,e,f)),b.cvsRender&&b.cvsRender(a),c.Core.instance._debug&&b._debugColor&&(a.strokeStyle=b._debugColor,a.strokeRect(0,0,e,f)),b._clipping&&(a.beginPath(),a.rect(0,0,e,f),a.clip()),b.childNodes))for(var h=0,i=b.childNodes.length;h<i;h++)g=b.childNodes[h],this.render(a,g,d);a.restore(),c.Matrix.instance.stack.pop()},detectRender:function(a,b){var d,e,f;if("undefined"==typeof b._visible||b._visible){if(d=b.width,e=b.height,a.save(),this.transform(a,b),a.fillStyle=b._cvsCache.detectColor,b._touchEnabled&&(b.detectRender?b.detectRender(a):a.fillRect(0,0,d,e)),b._clipping&&(a.beginPath(),a.rect(0,0,d,e),a.clip()),b.childNodes)for(var g=0,h=b.childNodes.length;g<h;g++)f=b.childNodes[g],this.detectRender(a,f);a.restore(),c.Matrix.instance.stack.pop()}},transform:function(a,b){var d,e,f,g,h=c.Matrix.instance,i=h.stack;b._dirty?(h.makeTransformMatrix(b,b._cvsCache.matrix),d=[],h.multiply(i[i.length-1],b._cvsCache.matrix,d),b._matrix=d,e="number"==typeof b._originX?b._originX:b._width/2||0,f="number"==typeof b._originY?b._originY:b._height/2||0,g=[e,f],h.multiplyVec(d,g,g),b._offsetX=g[0]-e,b._offsetY=g[1]-f,b._dirty=!1):d=b._matrix,i.push(d),a.setTransform.apply(a,d)}}),c.CanvasRenderer.instance=new c.CanvasRenderer,c.Scene=c.Class.create(c.Group,{initialize:function(){var a=c.Core.instance;c.Group.call(this),this.scene=this,this._backgroundColor=null,this._element=document.createElement("div"),this._element.style.position="absolute",this._element.style.overflow="hidden",this._element.style[c.ENV.VENDOR_PREFIX+"TransformOrigin"]="0 0",this._layers={},this._layerPriority=[],this.addEventListener(c.Event.CHILD_ADDED,this._onchildadded),this.addEventListener(c.Event.CHILD_REMOVED,this._onchildremoved),this.addEventListener(c.Event.ENTER,this._onenter),this.addEventListener(c.Event.EXIT,this._onexit);var b=this;this._dispatchExitframe=function(){var a;for(var d in b._layers)a=b._layers[d],a.dispatchEvent(new c.Event(c.Event.EXIT_FRAME))},this.addEventListener(c.Event.CORE_RESIZE,this._oncoreresize),this._oncoreresize(a)},x:{get:function(){return this._x},set:function(a){this._x=a;for(var b in this._layers)this._layers[b].x=a}},y:{get:function(){return this._y},set:function(a){this._y=a;for(var b in this._layers)this._layers[b].y=a}},width:{get:function(){return this._width},set:function(a){this._width=a;for(var b in this._layers)this._layers[b].width=a}},height:{get:function(){return this._height},set:function(a){this._height=a;for(var b in this._layers)this._layers[b].height=a}},rotation:{get:function(){return this._rotation},set:function(a){this._rotation=a;for(var b in this._layers)this._layers[b].rotation=a}},scaleX:{get:function(){return this._scaleX},set:function(a){this._scaleX=a;for(var b in this._layers)this._layers[b].scaleX=a}},scaleY:{get:function(){return this._scaleY},set:function(a){this._scaleY=a;for(var b in this._layers)this._layers[b].scaleY=a}},backgroundColor:{get:function(){return this._backgroundColor},set:function(a){this._backgroundColor=this._element.style.backgroundColor=a}},remove:function(){for(this.clearEventListener();this.childNodes.length>0;)this.childNodes[0].remove();return c.Core.instance.removeScene(this)},_oncoreresize:function(a){this._element.style.width=a.width+"px",this.width=a.width,this._element.style.height=a.height+"px",this.height=a.height,this._element.style[c.ENV.VENDOR_PREFIX+"Transform"]="scale("+a.scale+")";for(var b in this._layers)this._layers[b].dispatchEvent(a)},addLayer:function(a,b){var d=c.Core.instance;if(!this._layers[a]){var e=new c[a+"Layer"];d.currentScene===this&&e._startRendering(),this._layers[a]=e;var f=e._element;if("number"==typeof b){var g=this._element.childNodes[b];g?this._element.insertBefore(f,g):this._element.appendChild(f),this._layerPriority.splice(b,0,a)}else this._element.appendChild(f),this._layerPriority.push(a);e._scene=this}},_determineEventTarget:function(a){for(var b,c,d=this._layerPriority.length-1;d>=0&&(b=this._layers[this._layerPriority[d]],!(c=b._determineEventTarget(a)));d--);return c||(c=this),c},_onchildadded:function(a){var b,c,d=a.node,e=a.next;d._element?(b="Dom",c=1):(b="Canvas",c=0),this._layers[b]||this.addLayer(b,c),d._layer=this._layers[b],this._layers[b].insertBefore(d,e),d.parentNode=this},_onchildremoved:function(a){var b=a.node;b._layer.removeChild(b),b._layer=null},_onenter:function(){for(var a in this._layers)this._layers[a]._startRendering();c.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){for(var a in this._layers)this._layers[a]._stopRendering();c.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),c.LoadingScene=c.Class.create(c.Scene,{initialize:function(){c.Scene.call(this),this.backgroundColor="#000";var a=.4*this.width|0,b=.05*this.width|0,d=.03*a|0,e=new c.Sprite(a,b);e.disableCollection(),e.x=(this.width-a)/2,e.y=(this.height-b)/2;var f=new c.Surface(a,b);f.context.fillStyle="#fff",f.context.fillRect(0,0,a,b),f.context.fillStyle="#000",f.context.fillRect(d,d,a-2*d,b-2*d),e.image=f;var g=0,h=0;this.addEventListener("progress",function(a){g=a.loaded/a.total*1}),e.addEventListener("enterframe",function(){h*=.9,h+=.1*g,f.context.fillStyle="#fff",f.context.fillRect(d,0,(a-2*d)*h,b)}),this.addChild(e),this.addEventListener("load",function(a){var b=c.Core.instance;b.removeScene(b.loadingScene),b.dispatchEvent(a)})}}),c.CanvasScene=c.Class.create(c.Scene,{initialize:function(){c.Scene.call(this),this.addLayer("Canvas")},_determineEventTarget:function(a){var b=this._layers.Canvas._determineEventTarget(a);return b||(b=this),b},_onchildadded:function(a){var b=a.node,c=a.next;b._layer=this._layers.Canvas,this._layers.Canvas.insertBefore(b,c)},_onenter:function(){this._layers.Canvas._startRendering(),c.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){this._layers.Canvas._stopRendering(),c.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),c.DOMScene=c.Class.create(c.Scene,{initialize:function(){c.Scene.call(this),this.addLayer("Dom")},_determineEventTarget:function(a){var b=this._layers.Dom._determineEventTarget(a);return b||(b=this),b},_onchildadded:function(a){var b=a.node,c=a.next;b._layer=this._layers.Dom,this._layers.Dom.insertBefore(b,c)},_onenter:function(){this._layers.Dom._startRendering(),c.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){this._layers.Dom._stopRendering(),
c.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),c.Surface=c.Class.create(c.EventTarget,{initialize:function(a,b){c.EventTarget.call(this);var d=c.Core.instance;this.width=Math.ceil(a),this.height=Math.ceil(b),this.context=null;var e="enchant-surface"+d._surfaceID++;if(document.getCSSCanvasContext){this.context=document.getCSSCanvasContext("2d",e,a,b),this._element=this.context.canvas,this._css="-webkit-canvas("+e+")";this.context}else document.mozSetImageElement?(this._element=document.createElement("canvas"),this._element.width=a,this._element.height=b,this._css="-moz-element(#"+e+")",this.context=this._element.getContext("2d"),document.mozSetImageElement(e,this._element)):(this._element=document.createElement("canvas"),this._element.width=a,this._element.height=b,this._element.style.position="absolute",this.context=this._element.getContext("2d"),c.ENV.CANVAS_DRAWING_METHODS.forEach(function(a){var b=this.context[a];this.context[a]=function(){b.apply(this,arguments),this._dirty=!0}},this))},getPixel:function(a,b){return this.context.getImageData(a,b,1,1).data},setPixel:function(a,b,c,d,e,f){var g=this.context.createImageData(1,1);g.data[0]=c,g.data[1]=d,g.data[2]=e,g.data[3]=f,this.context.putImageData(g,a,b)},clear:function(){this.context.clearRect(0,0,this.width,this.height)},draw:function(a){if(a=a._element,1===arguments.length)this.context.drawImage(a,0,0);else{var b=arguments;b[0]=a,this.context.drawImage.apply(this.context,b)}},clone:function(){var a=new c.Surface(this.width,this.height);return a.draw(this),a},toDataURL:function(){var a=this._element.src;return a?"data:"===a.slice(0,5)?a:this.clone().toDataURL():this._element.toDataURL()}}),c.Surface.load=function(a,b,d){var e=new Image,f=Object.create(c.Surface.prototype,{context:{value:null},_css:{value:"url("+a+")"},_element:{value:e}});return c.EventTarget.call(f),d=d||function(){},f.addEventListener("load",b),f.addEventListener("error",d),e.onerror=function(){var a=new c.Event(c.Event.ERROR);a.message="Cannot load an asset: "+e.src,c.Core.instance.dispatchEvent(a),f.dispatchEvent(a)},e.onload=function(){f.width=e.width,f.height=e.height,f.dispatchEvent(new c.Event("load"))},e.src=a,f},c.Surface._staticCanvas2DContext=document.createElement("canvas").getContext("2d"),c.Surface._getPattern=function(a,b){return a._pattern&&!b||(a._pattern=this._staticCanvas2DContext.createPattern(a._element,"repeat")),a._pattern},a.Deferred?c.Deferred=a.Deferred:(c.Deferred=c.Class.create({initialize:function(){this._succ=this._fail=this._next=this._id=null,this._tail=this},next:function(a){var b=new c.Deferred;return b._succ=a,this._add(b)},error:function(a){var b=new c.Deferred;return b._fail=a,this._add(b)},_add:function(a){return this._tail._next=a,this._tail=a,this},call:function(a){for(var b,d=this;d&&!d._succ;)d=d._next;if(d instanceof c.Deferred){try{b=d._succ(a)}catch(e){return d.fail(e)}b instanceof c.Deferred?c.Deferred._insert(d,b):d._next instanceof c.Deferred&&d._next.call(b)}},fail:function(a){for(var b,d,e=this;e&&!e._fail;)e=e._next;if(!(e instanceof c.Deferred))throw a instanceof Error?a:(d=new Error("failed in Deferred"),d.arg=a,d);b=e._fail(a),e.call(b)}}),c.Deferred._insert=function(a,b){a._next instanceof c.Deferred&&(b._tail._next=a._next),a._next=b},c.Deferred.next=function(a){var b=(new c.Deferred).next(a);return b._id=setTimeout(function(){b.call()},0),b},c.Deferred.parallel=function(a){var b=new c.Deferred;b._id=setTimeout(function(){b.call()},0);var d=0,e=a instanceof Array?[]:{},f=new c.Deferred;for(var g in a)a.hasOwnProperty(g)&&(d++,function(a,b){a.next(function(a){d--,e[b]=a,d<=0&&f.call(e)}).error(function(a){f.fail(a)}),"number"==typeof a._id&&clearTimeout(a._id),a._id=setTimeout(function(){a.call()},0)}(a[g],g));return d||(f._id=setTimeout(function(){f.call(e)},0)),b.next(function(){return f})}),c.DOMSound=c.Class.create(c.EventTarget,{initialize:function(){throw c.EventTarget.call(this),this.duration=0,new Error("Illegal Constructor")},play:function(){this._element&&this._element.play()},pause:function(){this._element&&this._element.pause()},stop:function(){this.pause(),this.currentTime=0},clone:function(){var a;if(this._element instanceof Audio)a=Object.create(c.DOMSound.prototype,{_element:{value:this._element.cloneNode(!1)},duration:{value:this.duration}});else{if(c.ENV.USE_FLASH_SOUND)return this;a=Object.create(c.DOMSound.prototype)}return c.EventTarget.call(a),a},currentTime:{get:function(){return this._element?this._element.currentTime:0},set:function(a){this._element&&(this._element.currentTime=a)}},volume:{get:function(){return this._element?this._element.volume:1},set:function(a){this._element&&(this._element.volume=a)}}}),c.DOMSound.load=function(b,d,e,f){if(null==d){var g=c.Core.findExt(b);d=g?"audio/"+g:""}d=d.replace("mp3","mpeg").replace("m4a","mp4"),e=e||function(){},f=f||function(){};var h=Object.create(c.DOMSound.prototype);c.EventTarget.call(h),h.addEventListener("load",e),h.addEventListener("error",f);var i=new Audio;if(!c.ENV.SOUND_ENABLED_ON_MOBILE_SAFARI&&"webkit"===c.ENV.VENDOR_PREFIX&&c.ENV.TOUCH_ENABLED)a.setTimeout(function(){h.dispatchEvent(new c.Event("load"))},0);else if(!c.ENV.USE_FLASH_SOUND&&i.canPlayType(d))i.addEventListener("canplaythrough",function a(){h.duration=i.duration,h.dispatchEvent(new c.Event("load")),i.removeEventListener("canplaythrough",a)},!1),i.src=b,i.load(),i.autoplay=!1,i.onerror=function(){var a=new c.Event(c.Event.ERROR);a.message="Cannot load an asset: "+i.src,c.Core.instance.dispatchEvent(a),h.dispatchEvent(a)},h._element=i;else if("audio/mpeg"===d){var j=document.createElement("embed"),k="enchant-audio"+c.Core.instance._soundID++;j.width=j.height=1,j.name=k,j.src="sound.swf?id="+k+"&src="+b,j.allowscriptaccess="always",j.style.position="absolute",j.style.left="-1px",h.addEventListener("load",function(){Object.defineProperties(j,{currentTime:{get:function(){return j.getCurrentTime()},set:function(a){j.setCurrentTime(a)}},volume:{get:function(){return j.getVolume()},set:function(a){j.setVolume(a)}}}),h._element=j,h.duration=j.getDuration()}),c.Core.instance._element.appendChild(j),c.DOMSound[k]=h}else a.setTimeout(function(){h.dispatchEvent(new c.Event("load"))},0);return h},a.AudioContext=a.AudioContext||a.webkitAudioContext||a.mozAudioContext||a.msAudioContext||a.oAudioContext,c.WebAudioSound=c.Class.create(c.EventTarget,{initialize:function(){if(!a.AudioContext)throw new Error("This browser does not support WebAudio API.");c.EventTarget.call(this),c.WebAudioSound.audioContext||(c.WebAudioSound.audioContext=new a.AudioContext,c.WebAudioSound.destination=c.WebAudioSound.audioContext.destination),this.context=c.WebAudioSound.audioContext,this.src=this.context.createBufferSource(),this.buffer=null,this._volume=1,this._currentTime=0,this._state=0,this.connectTarget=c.WebAudioSound.destination},play:function(a){1!==this._state||a||this.src.disconnect(),2!==this._state&&(this._currentTime=0);var b=this._currentTime,c=this.context;this.src=c.createBufferSource(),null!=c.createGain?this._gain=c.createGain():this._gain=c.createGainNode(),this.src.buffer=this.buffer,this._gain.gain.value=this._volume,this.src.connect(this._gain),this._gain.connect(this.connectTarget),null!=this.src.start?this.src.start(0,b,this.buffer.duration-b-1.192e-7):this.src.noteGrainOn(0,b,this.buffer.duration-b-1.192e-7),this._startTime=c.currentTime-this._currentTime,this._state=1},pause:function(){var a=this.currentTime;a!==this.duration&&(null!=this.src.stop?this.src.stop(0):this.src.noteOff(0),this._currentTime=a,this._state=2)},stop:function(){null!=this.src.stop?this.src.stop(0):this.src.noteOff(0),this._state=0},clone:function(){var a=new c.WebAudioSound;return a.buffer=this.buffer,a},duration:{get:function(){return this.buffer?this.buffer.duration:0}},volume:{get:function(){return this._volume},set:function(a){a=Math.max(0,Math.min(1,a)),this._volume=a,this.src&&(this._gain.gain.value=a)}},currentTime:{get:function(){return Math.max(0,Math.min(this.duration,this.src.context.currentTime-this._startTime))},set:function(a){this._currentTime=a,2!==this._state&&this.play(!1)}}}),c.WebAudioSound.load=function(a,b,d,e){function f(){var b=new c.Event(c.Event.ERROR);b.message="Cannot load an asset: "+a,c.Core.instance.dispatchEvent(b),h.dispatchEvent(b)}var g=(new Audio).canPlayType(b),h=new c.WebAudioSound;d=d||function(){},e=e||function(){},h.addEventListener(c.Event.LOAD,d),h.addEventListener(c.Event.ERROR,e);var i,j;return"maybe"===g||"probably"===g?(i=c.WebAudioSound.audioContext,j=new XMLHttpRequest,j.open("GET",a,!0),j.responseType="arraybuffer",j.onload=function(){i.decodeAudioData(j.response,function(a){h.buffer=a,h.dispatchEvent(new c.Event(c.Event.LOAD))},f)},j.onerror=f,j.send(null)):setTimeout(f,50),h},c.Sound=a.AudioContext&&c.ENV.USE_WEBAUDIO?c.WebAudioSound:c.DOMSound,c.Easing={LINEAR:function(a,b,c,d){return c*a/d+b},SWING:function(a,b,c,d){return c*(.5-Math.cos(a/d*Math.PI)/2)+b},QUAD_EASEIN:function(a,b,c,d){return c*(a/=d)*a+b},QUAD_EASEOUT:function(a,b,c,d){return-c*(a/=d)*(a-2)+b},QUAD_EASEINOUT:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b},CUBIC_EASEIN:function(a,b,c,d){return c*(a/=d)*a*a+b},CUBIC_EASEOUT:function(a,b,c,d){return c*((a=a/d-1)*a*a+1)+b},CUBIC_EASEINOUT:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a*a+b:c/2*((a-=2)*a*a+2)+b},QUART_EASEIN:function(a,b,c,d){return c*(a/=d)*a*a*a+b},QUART_EASEOUT:function(a,b,c,d){return-c*((a=a/d-1)*a*a*a-1)+b},QUART_EASEINOUT:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a*a*a+b:-c/2*((a-=2)*a*a*a-2)+b},QUINT_EASEIN:function(a,b,c,d){return c*(a/=d)*a*a*a*a+b},QUINT_EASEOUT:function(a,b,c,d){return c*((a=a/d-1)*a*a*a*a+1)+b},QUINT_EASEINOUT:function(a,b,c,d){return(a/=d/2)<1?c/2*a*a*a*a*a+b:c/2*((a-=2)*a*a*a*a+2)+b},SIN_EASEIN:function(a,b,c,d){return-c*Math.cos(a/d*(Math.PI/2))+c+b},SIN_EASEOUT:function(a,b,c,d){return c*Math.sin(a/d*(Math.PI/2))+b},SIN_EASEINOUT:function(a,b,c,d){return-c/2*(Math.cos(Math.PI*a/d)-1)+b},CIRC_EASEIN:function(a,b,c,d){return-c*(Math.sqrt(1-(a/=d)*a)-1)+b},CIRC_EASEOUT:function(a,b,c,d){return c*Math.sqrt(1-(a=a/d-1)*a)+b},CIRC_EASEINOUT:function(a,b,c,d){return(a/=d/2)<1?-c/2*(Math.sqrt(1-a*a)-1)+b:c/2*(Math.sqrt(1-(a-=2)*a)+1)+b},ELASTIC_EASEIN:function(a,b,c,d,e,f){if(0===a)return b;if(1===(a/=d))return b+c;f||(f=.3*d);var g;return!e||e<Math.abs(c)?(e=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/e),-(e*Math.pow(2,10*(a-=1))*Math.sin((a*d-g)*(2*Math.PI)/f))+b},ELASTIC_EASEOUT:function(a,b,c,d,e,f){if(0===a)return b;if(1===(a/=d))return b+c;f||(f=.3*d);var g;return!e||e<Math.abs(c)?(e=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/e),e*Math.pow(2,-10*a)*Math.sin((a*d-g)*(2*Math.PI)/f)+c+b},ELASTIC_EASEINOUT:function(a,b,c,d,e,f){if(0===a)return b;if(2===(a/=d/2))return b+c;f||(f=d*(.3*1.5));var g;return!e||e<Math.abs(c)?(e=c,g=f/4):g=f/(2*Math.PI)*Math.asin(c/e),a<1?-.5*(e*Math.pow(2,10*(a-=1))*Math.sin((a*d-g)*(2*Math.PI)/f))+b:e*Math.pow(2,-10*(a-=1))*Math.sin((a*d-g)*(2*Math.PI)/f)*.5+c+b},BOUNCE_EASEOUT:function(a,b,c,d){return(a/=d)<1/2.75?c*(7.5625*a*a)+b:a<2/2.75?c*(7.5625*(a-=1.5/2.75)*a+.75)+b:a<2.5/2.75?c*(7.5625*(a-=2.25/2.75)*a+.9375)+b:c*(7.5625*(a-=2.625/2.75)*a+.984375)+b},BOUNCE_EASEIN:function(a,b,d,e){return d-c.Easing.BOUNCE_EASEOUT(e-a,0,d,e)+b},BOUNCE_EASEINOUT:function(a,b,d,e){return a<e/2?.5*c.Easing.BOUNCE_EASEIN(2*a,0,d,e)+b:.5*c.Easing.BOUNCE_EASEOUT(2*a-e,0,d,e)+.5*d+b},BACK_EASEIN:function(a,c,d,e,f){return f===b&&(f=1.70158),d*(a/=e)*a*((f+1)*a-f)+c},BACK_EASEOUT:function(a,c,d,e,f){return f===b&&(f=1.70158),d*((a=a/e-1)*a*((f+1)*a+f)+1)+c},BACK_EASEINOUT:function(a,c,d,e,f){return f===b&&(f=1.70158),(a/=e/2)<1?d/2*(a*a*(((f*=1.525)+1)*a-f))+c:d/2*((a-=2)*a*(((f*=1.525)+1)*a+f)+2)+c},EXPO_EASEIN:function(a,b,c,d){return 0===a?b:c*Math.pow(2,10*(a/d-1))+b},EXPO_EASEOUT:function(a,b,c,d){return a===d?b+c:c*(-Math.pow(2,-10*a/d)+1)+b},EXPO_EASEINOUT:function(a,b,c,d){return 0===a?b:a===d?b+c:(a/=d/2)<1?c/2*Math.pow(2,10*(a-1))+b:c/2*(-Math.pow(2,-10*--a)+2)+b}},c.ActionEventTarget=c.Class.create(c.EventTarget,{initialize:function(){c.EventTarget.apply(this,arguments)},dispatchEvent:function(a){var b=this.node?this.node:this;a.target=b,a.localX=a.x-b._offsetX,a.localY=a.y-b._offsetY,null!=this["on"+a.type]&&this["on"+a.type].call(b,a);var c=this._listeners[a.type];if(null!=c){c=c.slice();for(var d=0,e=c.length;d<e;d++)c[d].call(b,a)}}}),c.Timeline=c.Class.create(c.EventTarget,{initialize:function(a){c.EventTarget.call(this),this.node=a,this.queue=[],this.paused=!1,this.looped=!1,this.isFrameBased=!0,this._parallel=null,this._activated=!1,this.addEventListener(c.Event.ENTER_FRAME,this._onenterframe);var b=this;this._nodeEventListener=function(a){b.dispatchEvent(a)}},_deactivateTimeline:function(){this._activated&&(this._activated=!1,this.node.removeEventListener("enterframe",this._nodeEventListener))},_activateTimeline:function(){this._activated||this.paused||(this.node.addEventListener("enterframe",this._nodeEventListener),this._activated=!0)},_onenterframe:function(a){this.paused||this.tick(this.isFrameBased?1:a.elapsed)},setFrameBased:function(){this.isFrameBased=!0},setTimeBased:function(){this.isFrameBased=!1},next:function(a){var b,d=this.queue.shift();if(d&&(b=new c.Event("actionend"),b.timeline=this,d.dispatchEvent(b),b=new c.Event("removedfromtimeline"),b.timeline=this,d.dispatchEvent(b),this.looped&&this.add(d)),0===this.queue.length)return void this._deactivateTimeline();if(a>0||this.queue[0]&&0===this.queue[0].time){var e=new c.Event("actiontick");e.elapsed=a,e.timeline=this,this.queue[0].dispatchEvent(e)}},tick:function(a){if(this.queue.length>0){var b=this.queue[0];if(0===b.frame){var d;d=new c.Event("actionstart"),d.timeline=this,b.dispatchEvent(d)}var e=new c.Event("actiontick");e.timeline=this,e.elapsed=a,b.dispatchEvent(e)}},add:function(a){this._activateTimeline(),this._parallel?(this._parallel.actions.push(a),this._parallel=null):this.queue.push(a),a.frame=0;var b=new c.Event("addedtotimeline");return b.timeline=this,a.dispatchEvent(b),b=new c.Event("actionadded"),b.action=a,this.dispatchEvent(b),this},action:function(a){return this.add(new c.Action(a))},tween:function(a){return this.add(new c.Tween(a))},clear:function(){var a=new c.Event("removedfromtimeline");a.timeline=this;for(var b=0,d=this.queue.length;b<d;b++)this.queue[b].dispatchEvent(a);return this.queue=[],this._deactivateTimeline(),this},skip:function(a){var b=new c.Event("enterframe");for(this.isFrameBased?b.elapsed=1:(b.elapsed=a,a=1);a--;)this.dispatchEvent(b);return this},pause:function(){return this.paused||(this.paused=!0,this._deactivateTimeline()),this},resume:function(){return this.paused&&(this.paused=!1,this._activateTimeline()),this},loop:function(){return this.looped=!0,this},unloop:function(){return this.looped=!1,this},delay:function(a){return this.action({time:a})},wait:function(a){return this},then:function(a){return this.action({onactiontick:function(b){a.call(this)},time:0})},exec:function(a){return this.then(a)},cue:function(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&(this.delay(c-b),this.then(a[c]),b=c);return this},repeat:function(a,b){return this.action({onactiontick:function(b){a.call(this)},time:b})},and:function(){var a=this.queue.pop();if(a instanceof c.ParallelAction)this._parallel=a,this.queue.push(a);else{var b=new c.ParallelAction;b.actions.push(a),this.queue.push(b),this._parallel=b}return this},or:function(){return this},doAll:function(a){return this},waitAll:function(){return this},waitUntil:function(a){return this.action({onactiontick:function(b){a.call(this)&&b.timeline.next()}})},fadeTo:function(a,b,c){return this.tween({opacity:a,time:b,easing:c})},fadeIn:function(a,b){return this.fadeTo(1,a,b)},fadeOut:function(a,b){return this.fadeTo(0,a,b)},moveTo:function(a,b,c,d){return this.tween({x:a,y:b,time:c,easing:d})},moveX:function(a,b,c){return this.tween({x:a,time:b,easing:c})},moveY:function(a,b,c){return this.tween({y:a,time:b,easing:c})},moveBy:function(a,b,c,d){return this.tween({x:function(){return this.x+a},y:function(){return this.y+b},time:c,easing:d})},hide:function(){return this.then(function(){this.opacity=0})},show:function(){return this.then(function(){this.opacity=1})},removeFromScene:function(){return this.then(function(){this.parentNode.removeChild(this)})},scaleTo:function(a,b,c){var d,e;return"number"==typeof c?(d=arguments[0],e=arguments[1],b=arguments[2],c=arguments[3]):d=e=a,this.tween({scaleX:d,scaleY:e,time:b,easing:c})},scaleBy:function(a,b,c){var d,e;return"number"==typeof c?(d=arguments[0],e=arguments[1],b=arguments[2],c=arguments[3]):d=e=a,this.tween({scaleX:function(){return this.scaleX*d},scaleY:function(){return this.scaleY*e},time:b,easing:c})},rotateTo:function(a,b,c){return this.tween({rotation:a,time:b,easing:c})},rotateBy:function(a,b,c){return this.tween({rotation:function(){return this.rotation+a},time:b,easing:c})}}),c.Action=c.Class.create(c.ActionEventTarget,{initialize:function(a){c.ActionEventTarget.call(this),this.time=null,this.frame=0;for(var b in a)a.hasOwnProperty(b)&&null!=a[b]&&(this[b]=a[b]);var d=this;this.timeline=null,this.node=null,this.addEventListener(c.Event.ADDED_TO_TIMELINE,function(a){d.timeline=a.timeline,d.node=a.timeline.node,d.frame=0}),this.addEventListener(c.Event.REMOVED_FROM_TIMELINE,function(){d.timeline=null,d.node=null,d.frame=0}),this.addEventListener(c.Event.ACTION_TICK,function(a){var b=d.time-(d.frame+a.elapsed);null!=d.time&&b<=0?(d.frame=d.time,a.timeline.next(-b)):d.frame+=a.elapsed})}}),c.ParallelAction=c.Class.create(c.Action,{initialize:function(a){c.Action.call(this,a),this.actions=[],this.endedActions=[];var b=this;this.addEventListener(c.Event.ACTION_START,function(a){for(var c=0,d=b.actions.length;c<d;c++)b.actions[c].dispatchEvent(a)}),this.addEventListener(c.Event.ACTION_TICK,function(a){var d,e,f={next:function(a){var f=b.actions[d];b.actions.splice(d--,1),e=b.actions.length,b.endedActions.push(f);var g=new c.Event("actionend");g.timeline=this,f.dispatchEvent(g),g=new c.Event("removedfromtimeline"),g.timeline=this,f.dispatchEvent(g)}},g=new c.Event("actiontick");for(g.timeline=f,g.elapsed=a.elapsed,d=0,e=b.actions.length;d<e;d++)b.actions[d].dispatchEvent(g);0===b.actions.length&&a.timeline.next()}),this.addEventListener(c.Event.ADDED_TO_TIMELINE,function(a){for(var c=0,d=b.actions.length;c<d;c++)b.actions[c].dispatchEvent(a)}),this.addEventListener(c.Event.REMOVED_FROM_TIMELINE,function(){b.actions=b.endedActions,b.endedActions=[]})}}),c.Tween=c.Class.create(c.Action,{initialize:function(a){var b={},d={};c.Action.call(this,a),null==this.easing&&(this.easing=c.Easing.LINEAR);var e=this;this.addEventListener(c.Event.ACTION_START,function(){var c=["frame","time","callback","onactiontick","onactionstart","onactionend"];for(var f in a)if(a.hasOwnProperty(f)){var g;g="function"==typeof a[f]?a[f].call(e.node):a[f],c.indexOf(f)===-1&&(b[f]=e.node[f],d[f]=g)}}),this.addEventListener(c.Event.ACTION_TICK,function(a){var c=0===e.time?1:e.easing(Math.min(e.time,e.frame+a.elapsed),0,1,e.time)-e.easing(e.frame,0,1,e.time);for(var f in d)if(d.hasOwnProperty(f)){if("undefined"==typeof this[f])continue;e.node[f]+=(d[f]-b[f])*c,Math.abs(e.node[f])<1e-7&&(e.node[f]=0)}})}})}(window);